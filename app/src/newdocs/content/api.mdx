import { Link } from 'react-router-dom'
import links from '$shared/../links'

import docsStyles from '$newdocs/components/DocsLayout/docsLayout.pcss'
import styles from '$newdocs/components/DocsPages/API/apiPage.pcss'

import { 
    PublishMsgJSClient,
    NodeRestlerExample,
    PythonRequests,
    SubscribingJSClient 
} from './code/api.js'

import ApiExplorerImg from './images/api/api-explorer.png'

<section id="api-overview">

## API overview

Streamr provides a set of APIs for easy integration with other systems. The APIs cover [authentication](#authentication), data input, data output, and managing various resources within Streamr (such as streams, canvases, products, and dashboards).

There are <a href="https://en.wikipedia.org/wiki/Representational_state_transfer" target="_blank">REST</a>ful HTTP endpoints that can be accessed using any HTTP library with ease. You can explore these endpoints using the [API explorer](#api-explorer). You can expect:
- Predictable resource-oriented URL endpoints
- Form-encoded request bodies
- JSON-encoded responses
- Standard HTTP response codes, authentication, and verbs.

There are two APIs for requesting data from Streamr into external applications: the websocket-based streaming API, and the HTTP API. For efficiently publishing and subscribing to data in realtime, using the websocket API is recommended.

The streaming API can be used to control external applications using realtime events from Streamr. For example, you could push realtime stock prices into a mobile app, or update player positions in a multiplayer game. Or you could implement a thermostat by controlling warming or cooling based on a temperature measurement. The streaming API pushes new events to subscribed clients immediately when they become available.

Using a client library is recommended for most tasks and integrations:

- <a href="https://github.com/streamr-dev/streamr-client-javascript" target="_blank">JavaScript client library (official)</a> 
    - client works in the browser as well as node.js. The package is available on <a href="https://www.npmjs.com/package/streamr-client" target="_blank">npm</a>.
- <a href="https://github.com/streamr-dev/streamr-client-java" target="_blank">Java client library (official)</a>
- <a href="https://github.com/streamr-dev/streamr-client-python" target="_blank">Python client library (community)</a>

If you'd like to contribute a client library and get it listed here, check out our section on <Link to={`${links.newdocs.technicalNotes}#how-to-contribute`}>contributing</Link>.

### API behaviour

The body of the request should be a JSON object, encoded in UTF-8, containing the key-value pairs representing your data.

**Response codes**

Code | Description
---- | -----------
200  | Success (the response is empty)
400  | Invalid request
401  | Permission denied
403  | Authentication failed
404  | Stream not found
500  | Unexpected error

### Data output over websocket

The websocket protocol is easiest to use with one of the available client libraries. If there isn't a client library available for your language, you can dive into the details of the <a href="https://github.com/streamr-dev/streamr-client-protocol-js/blob/master/PROTOCOL.md" target="_blank">websocket protocol</a>.

</section>

<section id="authentication">

## Authentication

A session token is required to make requests to the REST API endpoints or over the websocket protocol. You can obtain a session token by authenticating with either of these three methods:
- [Signing a cryptographic challenge using an Ethereum private key](#challenge)
- [Using a permanent secret API key](#api-key)
- [Using a username and a password](#username-password)

Once you get a session token using one of the above methods, see the section on [using it](#session-token).

<a name="challenge"></a>

### Authenticating with Ethereum

You can use an Ethereum private key to authenticate by signing a challenge with it and providing your Ethereum public address for verification.

Use the `POST` endpoint at `/api/v1/login/challenge/YOUR-PUBLIC-ADDRESS` to generate a random text called a challenge, which looks like the following: 

```
{
    "id": "challenge-id"
    "challenge": "challenge-text-to-be-signed"
    "expires": "2018-10-22T08:38:59Z"
}
```

To authenticate, you must provide a response before the challenge expires. You can do it with a `POST` to `/api/v1/login/response`. It must contain the challenge, the signature and the Ethereum address in the following format:

```
{
    "challenge": {
	    "id": "challenge-id",
	    "challenge": "challenge-text-that-you-signed"
    },
    "signature": "signature-of-the-challenge",
    "address": "your-public-ethereum-address"
}
```

The signature must follow the convention described [here](https://github.com/ethereum/EIPs/blob/master/EIPS/eip-712.md). The secp256k1 ECDSA algorithm is applied on the keccak256 hash of a string derived from the challenge text:

`sign(keccak256("\x19Ethereum Signed Message:\n" + len(challengeText) + challengeText)))`

If the signature is correct, you will receive a [session token](#session-token).

<a name="api-key"></a>

### Authenticating with an API key

Any number of API keys can be attached to your user. You can manage your API keys on your profile page.

When reading from or writing to Streams, you can use a Stream-specific anonymous key instead of your user key to avoid exposing it. Anonymous keys can be managed on the details page of a Stream.

To obtain a [session token](#session-token) using an API key, send a `POST` request to the `/api/v1/login/apikey` endpoint with a JSON body like the one below:

```
{
    "apiKey": "YOUR-API-KEY"
}
```

<a name="username-password"></a>

### Authenticating with a username and a password

You can manage your username and password from your profile page. To obtain a [session token](#session-token) using your username and your password, send them as a `POST` request to the `/api/v1/login/password` endpoint with a JSON body in the following format:

```
{
	"username": "YOUR-USERNAME",
	"password": "YOUR-PASSWORD"
}
```

<a name="session-token"></a>

### Using the session token

By using one of the above authentication methods, you will obtain a session token response in the following format: 

```
{
    "token": "YOUR-SESSION-TOKEN"
    "expires": "2018-10-22T11:38:59Z"
}
```

You can now use this session token to make authenticated requests by including an `Authorization` header on every HTTP request with content as follows:

`Authorization: Bearer YOUR-SESSION-TOKEN`

The session token's expiration will be reset on every request to prevent you from getting logged out while using the API. If the token expires, you can obtain a new one exactly as before.

</section>

<section id="work-with-streams-via-api">

## Work with streams via API
--Duplicate section - Point to streams page--

</section>

<section id="api-explorer">

## API Explorer
The API Explorer is a tool to investigate and test various endpoints on the Streamr API. You can read more about the tool [here](https://medium.com/streamrblog/the-new-api-explorer-for-streamr-developers-e6af28c2c808). 

Click the tile below to launch the API explorer in a new tab.

<div className={docsStyles.centered}>
    <a href="https://api-explorer.streamr.com" target="_blank">
        <img src={ApiExplorerImg} />
    </a>
</div>

</section>
