import { Link } from 'react-router-dom'
import Warning from '$docs/components/Warning'

import docsLinks from '$shared/../docsLinks'

# Setting up a Broker node

Broker nodes are Streamr nodes that run externally to your application. You start up a node on a server, and interface with it remotely using one of the supported protocols.

The Broker node ships with plugins for HTTP, Websocket, and MQTT protocols. Libraries for these protocols exist in practically every programming language, meaning that you can conveniently publish and subscribe to data from the Streamr Network using any programming language. Learn how to <Link to={docsLinks.connectingApplications}>connect your applications</Link> to your node using one of these protocols.

When applications use the Streamr Network via a Broker node, data signing, encryption, validation, and other complex cryptography happens at the node. This offloads processing from the application, and is also suitable for environments with limited hardware resources.

<Warning>

The current stable version of the Streamr Client is `5.x` (at the time of writing, December 2021) which is connected to the [Corea Network](https://streamr.network/roadmap). The Brubeck Network Streamr Client is the [6.0.0-alpha.19](https://www.npmjs.com/package/streamr-client/v/6.0.0-alpha.19) build along with the `testnet` builds of the Broker node. The developer experience of the two networks is the same, however, the `6.0.0-alpha.19` client also runs as a light node in the network, whereas the `5.x` era client communicates to a Streamr run node, remotely. When the Streamr Network transitions into the Brubeck era (ETA Jan/Feb 2022), data guarantees of `5.x` clients will need to be reassessed. Publishing data to the Brubeck network will only be visible in the [Brubeck Core UI](https://brubeck.streamr.network). The Marketplace, Core app and CLI tool are currently all configured to interact with the Corea Network only. Take care not to mix networks during this transition period.

</Warning>

## Two ways to run your node

The software comes in two flavours of packaging: a Docker image and an npm package.

Which method should you choose? If you have either Docker or Node.js (14.x or newer) already installed, use the one you know. Otherwise, try the Docker approach first, and if that doesn’t work for you, go for the npm approach.

Once you have either Docker or Node.js installed, the steps to download and start the node are very similar, regardless of whether you’re running Linux, macOS, or Windows (use PowerShell). You may need to adapt the commands for your platform or install OS-specific dependencies, if they are missing.

## The configuration wizard

As part of both approaches, we show how to run the configuration wizard to initialize your node’s config file, which will be saved on your disk. The wizard will let you either generate or import an Ethereum private key for your node, as well as ask which plugins you want to enable.

## The Docker approach

If you don’t have Docker, get it [here](https://docs.docker.com/get-docker/). Once installed, you can download, configure, and start the Streamr Broker.

### Step 1: Set up a directory to be mounted into a running Docker container

You’ll need a place in the host operating system where the Broker configuration file will be stored. This directory will be mounted into the running Docker container so that it persists and remains accessible outside of Docker.

- Create the directory with the command:

```
mkdir ~/.streamrDocker
```

### Step 2: Configure your node with Docker and Config Wizard

- Start the config wizard with the below command. Docker will download the Broker image unless you have it already.

**Linux / macOS**

```
docker run -it -v $(cd ~/.streamrDocker; pwd):/root/.streamr streamr/broker-node:testnet bin/config-wizard
```

**Windows PowerShell**

```
cd ~/.streamrDocker
docker run -it -v ${pwd}:/root/.streamr streamr/broker-node:testnet bin/config-wizard
```

- Generate or Import Ethereum private key: generate one unless you have one you want to use with the node
- Plugins to enable: select the interface protocols you're planning to use and press 'enter'
- Select ports for plugins: press 'enter' for each one to use the defaults
- Path to store the configuration: press 'enter' to use the default

Towards the end, the wizard asks if you would like it to display your Ethereum private key. From here you should copy-paste it to a safe place! You can also find it later in the configuration file, which is saved by default to `.streamrDocker/broker-config.json` under your home directory.

### Step 3: Start the Broker Node using Docker

- Start the node with the below command:

**Linux / macOS**

```
docker run -it -p 7170:7170 -p 7171:7171 -p 1883:1883 -v $(cd ~/.streamrDocker; pwd):/root/.streamr streamr/broker-node:testnet
```

**Windows PowerShell**

```
cd ~/.streamrDocker
docker run -p 7170:7170 -p 7171:7171 -p 1883:1883 -it -v ${pwd}:/root/.streamr streamr/broker-node:testnet
```

You should start to see logging similar to this:

```
INFO [2021-08-19T11:50:55.535] (broker              ): StreamrClient reporting disabled
INFO [2021-08-19T11:50:55.538] (broker              ): Starting broker version 30.0.0
INFO [2021-08-19T11:50:55.560] (MqttServer          ): MQTT server listening on port 7171
INFO [2021-08-19T11:50:55.560] (WebsocketPlugin     ): started on port 7173
INFO [2021-08-19T11:50:55.560] (WebsocketServer     ): Websocket server listening on 7170
```

## The npm approach

If you don’t have Node.js, install it using [nvm](https://github.com/nvm-sh/nvm#installing-and-updating) or manually from the [Node.js site](https://nodejs.org/en/download/). The Broker requires at least Node.js version 14.x. Once installed, you can download, configure, and start the Streamr Broker.

### Step 1: Install the latest version using npm

- Run `npm install -g streamr-broker@testnet` to download and install the package. You may need administrative access to run this command.

```
npm install -g streamr-broker@testnet
```

- There can be plenty of output from npm. If the installation fails with an error, you should address it before continuing.

### Step 2: Configure your node with streamr-broker-init

- Run `streamr-broker-init` to generate a configuration file using a step-by-step wizard. Answer the questions by using arrow keys and ‘enter’ to navigate.
- Generate or Import Ethereum private key: generate one unless you have one you want to use with the node
- Plugins to enable: select the interface protocols you're planning to use and press 'enter'
- Select ports for plugins: press 'enter' for each one to use the defaults
- Path to store the configuration: press 'enter' to use the default

Towards the end, the wizard asks if you would like it to display your Ethereum private key. From here, you should copy-paste it to a safe place! You can also find it later in the configuration file, which is saved by default to `.streamr/broker-config.json` under your home directory.

### Step 3: Start the Broker node

- Run `streamr-broker` to start the node! You should start to see logging similar to this:

```
INFO [2021-08-19T11:50:55.535] (broker              ): StreamrClient reporting disabled
INFO [2021-08-19T11:50:55.538] (broker              ): Starting broker version 30.0.0
INFO [2021-08-19T11:50:55.560] (MqttServer          ): MQTT server listening on port 7171
INFO [2021-08-19T11:50:55.560] (WebsocketPlugin     ): started on port 7173
INFO [2021-08-19T11:50:55.560] (WebsocketServer     ): Websocket server listening on 7170
```

## Staying safe

The config file contains your node’s private key. If someone gets access to the private key, they can publish and subscribe as you, and steal any tokens you might have in your node's wallet! Read more about <Link to={docsLinks.identity}>identity, keys, and wallets</Link>.

## Keeping up to date

Learn how to <Link to={docsLinks.updatingABrokerNode}>keep your node up to date</Link>.

## Using your Broker node

Next, use your node to publish and subscribe data by <Link to={docsLinks.connectingApplications}>connecting your application</Link>, or learn about <Link to={docsLinks.mining}>mining</Link>.
