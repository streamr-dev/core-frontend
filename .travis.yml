language: node_js
node_js:
- '8'
sudo: true
branches:
  only:
  - master
  - development
  - beta
  - "/^v\\d+\\.\\d+(\\.\\d+)?(-\\S*)?$/"
before_install:
- sudo apt-get -y install expect
- pip install awscli --upgrade --user
- npm config set //registry.npmjs.org/:_authToken=$NPM_TOKEN
- npm i -g npm@^6.9.0
- cd app
install:
- npm ci
- true
cache:
  directories:
  - "$HOME/.npm"
env:
  global:
  - secure: g/km642SU0HZoBmYIkt3gsWoXonuXYN4rdYfXm2ynavMKyojbDLHM+EYLB1uk1vsGR8SITHTQaE1lBoSlgD9aTXzyhtnDp3VkWJAm3/sxQIE8HEoKRT+4odrV/DCoidMLmeIL0xqLSYc2u+fLKm6dMnEdOVwBRPMPSdx6EMfusEbv2fPBMbWNTSEk5Jd8ppR1QwpbJQomeSp9uhxIH8pQWYUD3/zmhl26xYZ93wJMDQXoNyCQhlfpL7IcTljWPI+LP/U7GgSjBON/NHQ7Ka0Pq2UIA9B0QfrMPMrqOHb8AG2P/RaUyBqu0Jay6sdpyrJxJpANv7OAPE4RhLgjJx9fK4qzBvV6dwqxFt+1sNQRZCHc3AL5P7QiE4uVahbfy7i0xq1/aoJPLkIUEwnGn1HD1TBYE4LDnukkkFqN/GCuMBor2rqJLobRYlOY6g+EFfaCrG1gKfqVFr98XxJbBbTV8fRdyiqiJzpXtTLVpxJL2KDNdnhrTI+l5+/wRsiROu3rv2d5V0W25qOhhE02IxHAyfDb63dhddBopxO0TyjE5v7yew6HbpukixSDap7dq+w/P6m0Z7MjrAc+tMUOW/36TGVcLdK1pdEl1heVhNA9KVfzFT3nUP9nua/9weScISusQdhw6+GZrRyFQSfAJqaUemyJbyl0VFuxcVIt+fVNLQ=
  - secure: hu5cpsMinQEpoNgnJv1XQ+509/57gM4dHg+mRXaAkZ7ha6k0AK1AmNgsCKYfs2G8Qe3eFGM3DTuJA0JV9vOcUeHNURGQKW+ukciSN1dT8dmLC6DAjgd89LIV5jsgAMBtNNCeIDwdpSEhe39nD4P1ligVpxxtY9kbOfK+F/cNbgj9ZpC/MZ55rniMa1JkZpfWwP3bdOcko56E+dB3/Dh8L0QF1hiDA1AwpGXQcO2jQ22HvTyUIezcgIYGGSUJ0N9gPhe7f0UQ4iCdMbq2rKv2wi4vzKQPFOkK8eYAUfhbv1iHy/bP2VX8tR7ac9XJuAznaHJ3tng8iEnvF5ForiaAVhtUNOUi1Hw0i2qdaoash0hJh3Aq8IwyFZiZYAQYmIC29VuoPQJgTPVECEDkzqs8fbC0nqwjG9aVP6OkGUgSmR9LChUVsF8ZfLAp/R4bY0XJh6vuqG00qfl90f2zooTA/HPQa7D2VJBEDretZLR0u1ufPHEPkl++o5MeaeNn98KYKOD66fqK+lHf1fmyBogRRefXFZFOi1zNgZTe+xA6nNHk9eAMvYf9CfIsRM7AVnBviTWBkx3S5KDcbof8rdyUymwu5T/7Hly6JZmYKLZ5esQHoV2J5LYOxeaZoXXLARgQkxdpf/9sxNVkkB8TW6llnk+Bd7o7Qn9to80m60X2zsQ=
  - secure: "nHD48tYG5jDsFdgE5h7ZLxEYmIeXmjlcB+lswQqTzBOAgPSPmf89OCH1AYXQz2Bf9DhynIspPIQxuM/peeaPNLiuvBKubVtmSTMLrM3dyy2x9XUUKnGDEQPS0lOWA6k/Nyx2k4tqyx8Jvlzfgy3ayWyQQOxm8Rfmn4oyNz4ePCOxKwVIaeNwvdLzg5MqU9oDgxsSL2CGuHRJ7zgyDxxm7rKQcNgFEifUtB3+U0t5WfElWvhyAkgzhTZlfcHhEPqnoDxuQmlHMFl5f6PSvJXSaWaF+Q+co5Apw1KKJOAhfT6e3Pe1dsxTrQzFzzJCKPbjoHfknUBmX4wV0YDTz5VsR/L4L4PqVlZgP8Y8MdbeBwqfZY624wa/x3V4kOtfucEJDVO/n8rAqm3SREdSTN6HwgV6mdr870PUZhG512ZMT7J9IfyeigtQt6OYYDWtCqMb4rYNDsZQeepzWKegdKCByuyxchJZ+1/yg30ql+qeYkdVWV8npjEFU10PGgpo1m21Sqjq6mfjMi7IWT+DSh0oFPj7ua6A/5VTw/5OjqrBHbFmRcCM2cKvuS5dyTG0ETdBDfstgdqINiwW1cYzq9yqu+KDwwOFbeiELAZoQVERDYPu1RbX6ccIi4bYbd09nknxAAcGl1XEegEKouQxBDb6XexOdDnbtaxTFMUa9BsAZyI="
  - SENTRY_ORG=streamr
  - SENTRY_PROJECT=marketplace
  - secure: FttWn322rLJj+iCCAyHxptnyj4LZPyNVx8owctcq8/C5hYC2cEWqEy0e7h4Hu1EUXlXVvgPa/b/ND1NZbKARNeiVtBFiwaThXNBJuttRWaVTV5WnKyVQNCcHeuWC/vYtIRSfW0sw1x7rSEMRqv2SRa7tqdkENCNmovr2soF8FyeImI1AxUXN+qlTAa6Nt8g2nNBUnes061O1bkAJJeH7vxAeLLSSvxGKtMCn+l31hKkSzwsc0M8bVCNoh95B8Klz0xgyfTn11sW1eQR2bkHctVn0VYc7LjMvnavQjD4kQUaTFb7bQrH1YSE2YetjIvNrUoHqcZETok86ONC0OoeJJeGl22cPYWThyANtBTer2dNkIXkJxVrF75nJ8T1Tr8aDd0Y2lOvH4OsP++1uHkGRgQ20cyl2t36BxZ30sIj2HALqGd9R7k+wUIyDSPYMu0N9NvTQjDvF3KWOTrKe8ImvOSxRukCe9sEIxPB159smpD4YsWHoJ/T0N9NC7D2S34tn9Nh4OZDnPpaDY5mrfa9yZC0cgIf6uj1X08fDhCq0cc5Jn3RqpTAImCs1r1xwCv2LfaxvYFrmt3+WmDq4eFW2kzhaOF9C74FzS+D4cm6GihbikWx1QrWZJUTnpRJ1Sl0Z4X5mPQAqA9MzIX+Eik1MrOOEaB4K5p4GTi++BEJwd1U=
  - secure: sUzjQJhRmjgRZX2aPcCChTbUpOObNR6virIw0AjfCtQlQQBF0AmCLOSgi4a6GIC4lBIl67flUwbAOHGOaRqVw1K6WZ1A8hEjcmBor6sbIIVtbbJFGr6GnozLeXI/fkTfFfH5n6oRvtJwZAk4GT1weiUzn0xCgvLcn7p5oXZ+M9qvTFDaWr18R9EQF9I+BDX3PwSuhrzveYH6mQRmXVIkoFYmmjAh2MNvP46fIS+HEGadhrpshUwipYmMZ0xyF+xw4Km2tj9okoP18C5UtG43/LcJ0Ja4Fg0WMqXlNSi+JcO5IEg0noJ/x77woIZtsNrphqhUgpp8PJJPBg2YyzQk57OPWVSDlaBfI2Jkhf0E/LTTFuzbORjBOgS2S4zWS8sHWtsnjECpiCb+v20PBIEcLjfUGJEhBW4bsNoJCtE1afUDCkcvarT9pQBqlOrVzvTNlAHyjBzB9JeWel0MKUm+g4/hSHhaDYVfAWGIo0fUboLL09+CVzKPcKfQjdu4vROyQWheDpC/kzvCEMhnaxIAB3fs6lA+BsBFo9lXFF93PVatBdo36mw6fJkk75kfXBOTu0D2fPWYryQm1GeE2uiTWLWscoOQ4GDh6o0vummVk6mxA1A1RU5p2lC8SrB3WMTvrM3dg3vTvzvUavP1WVnPmCoYg0+j+UVpkBEWvazNZqM=
  - OWNER=streamr
  - IMAGE_NAME=platform
jobs:
  include:
  - stage: Platform Tests
    if: type IN (pull_request)
    env:
    - DESCRIPTION=UNIT_TEST
    - STREAMR_API_URL=http://localhost/api/v1
    - STREAMR_WS_URL=ws://localhost/api/v1/ws
    - STREAMR_URL=http://localhost
    - PLATFORM_ORIGIN_URL=http://localhost
    script: "travis_retry $TRAVIS_BUILD_DIR/app/travis_scripts/unit-tests.sh"
    after_failure:
      - docker ps
      - $TRAVIS_BUILD_DIR/streamr-docker-dev/streamr-docker-dev/bin.sh log --all
notifications:
  slack:
    secure: MZDZjnItLHeXN+rnenRfwQd635zMZWHUExAlo/i8zmcGmrDXMhZbm8Ppf0L2mkEWAXmE0aS8r+HsZW4P9GacYUQBgrhOg2gLp0lthLbT/YJAg/5wOmXkWZbE3G1AMBS+b1O/eEyWMmlH7dmYoMIuLa8tSeY/qGaiENjauTKilska0gurm2F0HWq7TAKuWJ5x0YWOikXT+QK1UlPwdVDyut1L0FHd21JfxftpK0U+yaBiBuJRplRPMmQMWWo5IxMHaWY66eJKPl/Jrk78sKfZrex9PkTjmDKTXl9Aj8WWanJY0LuA6WYIBH5ft5znV5Of1WpnxaR915NXilDz9XL3zyRmHiWcUegSTIeYp2LNARB71iqomctrcd8sC9ti2m3ZBuj7SSli5nV65JwMf+BdJ0ZEhFRXQ9ovkacEs+e45XubsRms8z3gTghwTnfd1KcqJPwxrDzpS3KMsdEkb8GMjlS2o0Kof3OBEbbu3AF4ueF5fPCG/vYZPY995+FNdP9SCvNN+Z96CKWYWPobK6EuSuaSiIjfHj3ixrQcLA+UaXlPZzK3NTdnJXsohKh8YBeiFQCEFiy80n9AKoTMKaarcU6nNevw6url0d6CpF6IQwPoJeEwB3PAM9ITOzKzbtSKrzEAO8u66bt49dWy7VoNbY4m3WMnbgaCpqjI1AqP+SQ=
  on_success: change
  on_failure: always
  on_pull_requests: false
